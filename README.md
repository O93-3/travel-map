# Travel Map（旅行ルート可視化マップ）

> **旅の記録を「地図の作品」に変える。**  
> クリックするたび、ルートが伸び、世界があなたの履歴になる。

**Travel Map** は、旅行で訪れた都市を **ルート（線）＋マーカー** で記録し、最後に追加した都市を **現在地（Now Traveling）** として強調表示するWebアプリです。  
そして本プロジェクトの本領はここからです。v14では配信者向けに、**OBSでそのまま使えるオーバーレイを複数同梱**しました。

- **通常版（地図アプリ）**：旅の履歴を作る／見返す／育てる
- **配信用オーバーレイ**：画面の上に「旅の現在地」を“演出として”載せる

**無料で、ブラウザだけで動きます。** インストール不要。導入はURLを開くだけ。

---

## いますぐ起動（GitHub Pages）

- 起動（通常版）：
  - https://o93-3.github.io/travel-map/

> **保存は各PC（各ブラウザ）に保存**されます（localStorage）。  
> バージョン更新後に表示が崩れる／UIが戻らない場合は、右クリック → **「最新の状態に更新」**（強制更新）をお試しください。

---

# これ、何が“すごい”のか（推しポイント）

## ✅ 1クリックで「旅の軌跡」が増える
都市を追加するだけで、**ルート線が自動で伸び、マーカーが積み重なります。**  
「旅行の記録」を、スクショ映えする“地図の作品”に変換します。

## ✅ ルートの“今”がわかる：Now Traveling
最後に追加した都市を **現在地** として扱い、
- **テロップ表示（国名/都市名）**
- **脈動（pulsate）マーカー**
で、視線を一瞬で集めます。

## ✅ 画面づくりが楽しい：色・サイズを自分好みに
- ルート線の色
- 現在地マーカー色／過去マーカー色
- 現在地マーカーサイズ
- テロップの文字サイズ／旗サイズ／余白
など、**配信画面や好みに合わせて“見せ方”を詰められます。**

## ✅ 配信者向けに本気：OBSオーバーレイを同梱（v14）
「地図アプリで作った旅の履歴」を、
**配信画面の上にカードやミニマップとして載せられます。**

- ルートカード：FROM → TO ＋距離
- ミニマップ：直近ルートを自動ズーム表示

**“いまどこ？”が、配信の演出になります。**

---

# 使い方（基本：旅の履歴を作る）

1. 検索欄に **都市名/国名** を入力 → 候補が表示されます。
2. 候補をクリック（または ↑/↓ + Enter）→ **自動で追加** され、ルート線が伸びます。
3. 間違えたら **「ひとつ戻す」** で直近を取り消せます。
4. 色/サイズ等の調整は即時反映され、次回も保持されます。

---

# 機能一覧（これでもか、というくらい全部）

## 地図・表示
- Leaflet で地図表示（軽快）
- 初期表示：世界全体（[20,0] / zoom 2）
- 地図スタイル切替：標準 / 白黒 / 衛星 / 地形
- 国境色分けレイヤー（GeoJSON）ON/OFF

## ルート管理
- 都市を追加すると：マーカー追加＋ルート線（polyline）更新
- 直前と同じ都市の連打を防止（誤操作ガード）
- 「ひとつ戻す」で直近を取り消し、地図表示を再構築

## 都市検索（強い）
- 検索対象：国名/都市名（日本語/英語）/国コード など
- NFKC正規化＋小文字化で揺れに強い
- 候補最大30件
- 「現在地（最後に追加した都市）」または地図中心からの距離で並び替え（近い順優先）
- キーボード操作：↑/↓ で候補移動、Enter で確定追加、Esc で閉じる

## 現在地UI（演出力）
- Now Traveling テロップ（国名/都市名）
- 国旗表示（国コードがある場合、URL生成で表示）
- テロップはドラッグで移動可能、位置を保存

## カスタマイズ（配信者向けチューニング）
- ルート線カラー
- 現在地/過去マーカー色
- 現在地マーカーサイズ
- テロップ文字サイズ／旗サイズ／余白
- テーマ（tmTheme）

## UI
- UIは <details>/<summary> の折り畳み構成
- パネル内スクロール対応（画面外に伸びない）
- 配信モード：UIパネルを非表示（Escapeで解除）

## 同期
- 別タブで更新された localStorage を storageイベントで受けて再構築

---

# ✅ OBSオーバーレイ（v14）

オーバーレイは「旅の履歴（travelHistory）」を読み取って表示します。  
**配信画面に“現在地”と“直近ルート”を固定表示できる**ため、雑談・旅配信・ドライブ配信の「演出」が一段上がります。

## 同梱オーバーレイ（通常版）
- `overlay-card.html`：ルートカード（FROM→TO＋距離）
  - 推奨サイズ：320×192
- `overlay-map.html`：ミニマップ（ルート＋自動ズーム）
  - 推奨サイズ：480×255
- `overlay.html`：互換用入口（現在は `overlay-card.html` にリダイレクト）

---

# ✅ OBSオーバーレイ（いちばん簡単：サーバー不要／一般向け）【推奨】

本プロジェクトの最難関は「普段のブラウザ」と「OBSブラウザ」が別環境になりやすい点です。  
そこで **ウィンドウキャプチャ＋クロマキー（緑抜き）** を正式に推奨します。

- **ユーザーがやることはシンプル**：ページを開く → OBSでウィンドウを選ぶ → 緑抜きする
- **ローカルサーバー不要**
- **外部サービス不要**

## 使うページ（緑抜き版）
- `overlay-card-key.html`（320×192／背景 #00ff00）
- `overlay-map-key.html`（480×255／背景 #00ff00）

## 手順（3分）
1. **同じブラウザ（Chrome か Edge）**で、次を開きます。
   - Travel Map（操作用）：`/index.html`
   - カード（緑抜き）：`/overlay-card-key.html`
   - ミニマップ（緑抜き）：`/overlay-map-key.html`

2. 可能なら `overlay-*-key.html` を **「アプリとしてインストール」**（または「ショートカット作成 → ウィンドウとして開く」）してください。
   - 目的：アドレスバー/タブを消して、OBS側の切り抜きを最小にするため

3. OBSに取り込みます。
   - ソース → **ウィンドウキャプチャ**（2つ作る：カード用／ミニマップ用）
   - 各ソースに **フィルタ → クロマキー**
     - Key Color Type：**Green**
     - まずは既定値のまま、輪郭が荒い場合だけ Similarity / Smoothness を少し調整

4. Travel Map 側で都市を追加します。
   - **2地点以上**追加すると、カード/ミニマップが更新されます

## ありがちな落とし穴（ここだけ注意）
- 操作はChrome、オーバーレイはEdge のように **別ブラウザで開く** → 更新されません
- 同じブラウザでも **別プロファイル（ゲスト/別ユーザー）** → 更新されません

---

# OBSブラウザソースで透明オーバーレイにしたい場合（上級者向け）

透明で合成したい場合はOBSブラウザソース運用も可能です。  
ただし、オーバーレイは `travelHistory` を読むため、**同一環境での更新**が必要になります。

- 確実に動かすには：
  - OBSに `index.html` もブラウザソースとして追加し、右クリック → **操作（Interact）** で都市追加する

---

# 保存データ（localStorage）

このアプリはブラウザの localStorage を使って状態を保持します。

- ルート履歴：`travelHistory`
- 地図スタイル：`mapStyle`
- 国境表示ON/OFF：`bordersOn`
- ルート線の色：`lineColor`
- 現在地/過去マーカー色：`currentColor`, `pastColor`
- 現在地マーカーサイズ：`curSize`
- 現在地テロップ設定：`locFontSize`, `locFlagSize`, `locPadding`
- テロップ位置：`locUI`
- テーマ：`tmTheme`
- 言語：`lang`

---

# 同梱データ

- `cities.json`：都市データ（EURO用）
- `cities-ATS.json`：都市データ（ATS/US用・州項目あり）
- `countries.geojson`：国境レイヤー（運用はこちら）
- `countries.geo.json`：受け渡し用（互換）

---

# PWA / Service Worker（sw.js）について（更新が反映されない原因の多くはこれ）

`sw.js` が有効な場合、`index.html` / `style.css` / `app.js` / `cities.json` などをキャッシュし、
**キャッシュ優先で返す**挙動になります。

- よくある症状
  - 古い見た目のまま
  - UIが戻らない
  - 修正が反映されない

- 対策
  - ブラウザ：右クリック → **「最新の状態に更新」**（強制更新）
  - それでもダメ：サイトデータ（キャッシュ/ストレージ）削除、または Service Worker の解除を検討
  - OBS：ブラウザソースなら右クリック → **更新（Refresh）**

---

# トラブルシューティング

## 地図が真っ白 / 動かない
- `app.js` が途中でエラー停止すると地図初期化が止まります。Console を確認してください。

## 検索候補が出ない
- `cities.json` の読み込み失敗の可能性があります。
- GitHub Pages（HTTPS）で開いているか確認してください。

## オーバーレイが更新されない（運用A）
- **同じブラウザ・同じプロファイル**で開いているか確認してください。

## カードが「ルートがまだありません」から変わらない
- 都市を **2つ以上** 追加してください（出発地/目的地が揃うまで表示できません）。

---

# 変更履歴（書き足し用）

- v14：OBS向けオーバーレイ `overlay-card.html` / `overlay-map.html` を追加
- v14：運用A向けに緑抜き版 `overlay-card-key.html` / `overlay-map-key.html` を追加
