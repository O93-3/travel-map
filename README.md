# Travel Map（旅行ルート可視化マップ）

**あなたの旅を、地図の上に“軌跡”として刻む。**  
Travel Map は、旅行で訪れた都市を **ルート（線）＋マーカー** で記録し、最後に追加した都市を **現在地（Now Traveling）** として強調表示する、シンプルで強力なWebアプリです。  
さらに v14 からは、配信向けに **OBSオーバーレイ（HTML）を2種類** 同梱。地図アプリの情報をそのまま配信画面に“かっこよく”載せられます。

---

## いますぐ使う（通常のWebアプリとして）

- 起動（GitHub Pages）：
  - https://o93-3.github.io/travel-map/

> **保存は各PC（ブラウザ）に保存** されます（localStorage）。別PC・別ブラウザには自動同期されません。  
> バージョン更新後に表示が崩れる／UIが戻らない場合は、右クリック→**「最新の状態に更新」**（強制更新）をお試しください。

---

## これは何ができるのか（ざっくり）

- **都市を検索して追加するだけ**で、ルートが伸びていく（線＋マーカー）。
- 最後に追加した都市を **現在地（Now Traveling）** としてテロップ表示＋脈動マーカー。
- 地図スタイル（標準/白黒/衛星/地形）の切替。
- 国境レイヤー（countries.geojson）を **ON/OFF**。
- 色・サイズなどを調整して、**自分好みに“見せる地図”に仕上げる**。
- 別タブの更新を拾って表示を追従（storageイベント＋ポーリング）。

---

## 操作手順（基本フロー）

1. 検索欄に **都市名/国名** を入力 → 候補が表示されます。
2. 候補をクリック（または ↑/↓ + Enter）→ **自動で追加** され、ルート線が伸びます。
3. 間違えたら **「ひとつ戻す」** で直近の追加を取り消せます。
4. 色/サイズ等の調整は即時反映され、次回も保持されます。

---

# ✅ 配信者向け：OBSオーバーレイ（NEW / v14）

Travel Map の“現在地”と“直近ルート”を、配信画面に自然に溶け込む **透明背景オーバーレイ** として表示できます。  
今回追加したHTMLはこの **2つ** です。

- **`overlay-card.html`**：ルートカード（FROM→TO＋距離）
  - 推奨サイズ：**320×192**
- **`overlay-map.html`**：ミニマップ（ルート＋自動ズーム）
  - 推奨サイズ：**480×255**

> `overlay.html` は互換用の入口で、現在は `overlay-card.html` へリダイレクトします。

---

## 重要：オーバーレイが更新される仕組み（ここがポイント）

オーバーレイは **Travel Map が保存している `travelHistory`（localStorage）** を読み取って表示します。  
つまり、**オーバーレイとTravel Mapが「同じ保存領域（同一オリジン・同一ブラウザ環境）」を見ている必要があります。**

- ✅ **おすすめ（確実）**：**ローカルサーバーで起動** → そのURLを OBS に入れる
- ⚠️ 注意：
  - 「普段のブラウザでTravel Mapを操作」＋「OBSのブラウザソースでオーバーレイ表示」だと、
    **保存領域が別物になり、オーバーレイが更新されない** 場合があります。
  - その場合は、Travel Map も **OBS側（ブラウザソース）で開いて操作**（OBSの「操作/Interact」）してください。

---

## OBSで使う（推奨：ローカルサーバー運用）

### 1) ローカルサーバーを起動
このフォルダ（`index.html` がある場所）で実行します。

```bash
python -m http.server 8000
```

ブラウザで開く：
- Travel Map（操作用）：`http://127.0.0.1:8000/index.html`
- オーバーレイ（カード）：`http://127.0.0.1:8000/overlay-card.html`
- オーバーレイ（ミニマップ）：`http://127.0.0.1:8000/overlay-map.html`

> ※ `file://`（ローカルファイル直開き）では、JSON読み込みや保存領域の扱いで問題が出やすいので、**必ずhttpで起動**してください。

### 2) OBSにブラウザソースとして追加
OBS → **ソース** → **+** → **ブラウザ** を追加します。

**A. Travel Map（操作用・見せない用）**
- URL：`http://127.0.0.1:8000/index.html`
- 置き方：
  - シーン外に置く／非表示にする（または別シーンに置く）
  - 必要なときに右クリック→**操作（Interact）** で追加作業

**B. overlay-card（カード表示）**
- URL：`http://127.0.0.1:8000/overlay-card.html`
- 幅/高さ：**320 / 192**（推奨）

**C. overlay-map（ミニマップ表示）**
- URL：`http://127.0.0.1:8000/overlay-map.html`
- 幅/高さ：**480 / 255**（推奨）

> まずは「A（操作用）」をOBSに入れるのがコツです。  
> Travel Map を OBS内で操作すれば、同じ保存領域を参照できるため、オーバーレイが確実に追従します。

### 3) オーバーレイが「空」のとき
2地点（出発地/目的地）が揃うまで、カード側は「ルートがまだありません」と表示します。
Travel Map で都市を **2つ以上追加** してください。

---

## GitHub Pagesでオーバーレイを使う場合（簡単だが注意あり）

URL例：
- `https://o93-3.github.io/travel-map/overlay-card.html`
- `https://o93-3.github.io/travel-map/overlay-map.html`

ただし前述のとおり、**OBSのブラウザソースと普段のブラウザは保存領域が別** になりやすいです。  
GitHub Pages運用で確実に更新したい場合は、Travel Map も **OBS内で開いて操作** してください。

---

## 保存データ（localStorage）

このアプリはブラウザの localStorage を使って状態を保持します。

- ルート履歴：`travelHistory`
- 地図スタイル：`mapStyle`
- 国境表示ON/OFF：`bordersOn`
- ルート線の色：`lineColor`
- 現在地/過去マーカー色：`currentColor`, `pastColor`
- 現在地マーカーサイズ：`curSize`
- 現在地テロップ設定：`locFontSize`, `locFlagSize`, `locPadding`
- テロップ位置：`locUI`
- テーマ：`tmTheme`
- 言語：`lang`

---

## 同梱データ

- `cities.json`：都市データ（EURO用）
- `cities-ATS.json`：都市データ（ATS/US用・州項目あり）
- `countries.geojson`：国境レイヤー（運用はこちら）
- `countries.geo.json`：受け渡し用（互換）

---

## PWA / Service Worker（sw.js）について（更新が反映されない原因の多くはこれ）

`sw.js` が有効な場合、`index.html` / `style.css` / `app.js` / `cities.json` などをキャッシュし、
**キャッシュ優先で返す**挙動になります。

- 症状：
  - UIが戻らない／古い表示のまま／修正が反映されない
- 対策：
  - ブラウザ：右クリック→**「最新の状態に更新」**（強制更新）
  - それでもダメ：サイトデータ（キャッシュ/ストレージ）削除、または Service Worker の解除を検討
  - OBS：ブラウザソースを右クリック→**更新（Refresh）**、必要ならソース再作成

---

## トラブルシューティング

### 地図が真っ白 / 動かない
- `app.js` が途中でエラー停止すると地図初期化が止まります。ブラウザの Console を確認してください。

### 検索候補が出ない
- `cities.json` の読み込み失敗の可能性があります。
- `file://`直開きではなく、ローカルサーバー（http）で起動してください。

### OBSでオーバーレイが更新されない
- Travel Map と overlay が **同一オリジン・同一ブラウザ環境** を見ていない可能性が高いです。
- まずは **Travel Map をOBS内にも追加**し、右クリック→操作（Interact）で都市追加を行ってください。

---

## 変更履歴（書き足し用）

- v14：OBS向けオーバーレイ `overlay-card.html` / `overlay-map.html` を追加
