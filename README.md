起動はここから→https://o93-3.github.io/travel-map/
※保存は各PCに保存されます。verUP後などはキャッシュ等消さないといけないかもかも。

---------------------------------------------------------------
現時点でできること：全機能リスト（カテゴリ別）
0) 全体コンセプト（いまの完成状態）

都市データ（cities.json）から都市を選び、**訪問ルート（履歴）**として記録
地図上に 訪問点（マーカー）＋ルート線（ポリライン） を描画
いちばん新しい地点を 現在地（強調マーカー＋テロップ表示） にする
操作は UI（ボタン/セレクト）＋検索（候補クリック）＋キーボード で可能 

---------------------------------------------------------------
1) 都市検索（City Search）
✅ 検索入力

都市名 / 国名 / 国コード（英語・日本語）で検索可能（NFKC正規化＋小文字化）
入力のたびに検索するが、120msのデバウンスで負荷軽減（都市数が増えても重くなりにくい）

✅ 候補の並び順（重要）
一致度優先＋近い順（同点のとき）で並べる：

一致度（先頭一致＞部分一致）
同じ一致度内で 「現在地に近い順」（距離計算）
同距離などは 安定ソート（名前長など）

✅ 「現在地」の基準点（近い順の基準）

履歴がある → 最後に追加した都市（=現在地） を基準
履歴がない → 地図の中心を基準

---------------------------------------------------------------

2) 候補選択 → 即「追加＋移動」（配信向け）

候補を **クリック（正確には mousedown）**すると
→ 選択確定 → 候補を閉じる → 追加ボタン処理を実行（= 履歴追加＋地図移動＋描画）
確定後、検索欄は自動で空になる（次の検索が即できる）

---------------------------------------------------------------

3) キーボード操作（配信向け）
検索欄フォーカス中：

↑ / ↓：候補の選択位置を移動（ハイライトが動く）1
Enter：選択中候補を確定 → 即 追加＋移動（検索欄もクリア）
Esc：候補を閉じてフォーカス解除

---------------------------------------------------------------

4) ルート（履歴）管理
✅ 追加（履歴に積む）

追加 ボタン or 検索候補確定により、

新規マーカー追加（最新は強調色、過去は設定色）
線（ポリライン）更新
履歴を localStorage に保存
現在地テロップ更新
地図を都市位置へ移動（ズーム固定）

✅ ひとつ戻す（Undo）

ひとつ戻す で履歴の末尾を削除し、描画も戻す（マーカー1つ削除＋線更新）

✅ 復元（起動時）

起動時、localStorage の履歴からルートを再描画して復元

---------------------------------------------------------------

5) 誤操作防止（事故りにくさ）まとめ

✅ (A) クリック無反応事故の防止

✅ (B) 候補が勝手に閉じる/閉じないの事故防止

✅ (C) 連打事故防止（同一都市の連続追加）

直前と同じ都市を 連続で追加しないガード（配信中の誤連打対策）

✅ (D) 入力の後処理（次操作のしやすさ）

確定後に 検索欄を自動クリア（連続検索に強い）

✅ (E) UI要素が無い時の安全性

---------------------------------------------------------------

6) 地図表示・見た目
✅ ベースマップ切り替え（地図スタイル）

OSM / 白黒 / 衛星 / 地形 の切り替え
選んだスタイルを localStorage に保存して次回復元

✅ 国境（色分け）表示 ON/OFF

国境ポリゴン（GeoJSON）を読み込み
ON/OFF を切替、状態を localStorage に保存

---------------------------------------------------------------

7) 現在地テロップ（配信向けUI）

現在地表示のON/OFF
現在地マーカーサイズ調整
現在地テキストサイズ調整
旗サイズ調整
パディング調整
国名＋国コード＋都市名の2段表示（旗は国コードから取得）

✅ ドラッグ移動

現在地テロップはドラッグで位置移動
位置を localStorage 保存して復元

---------------------------------------------------------------

8) 見た目（マーカー）

過去マーカー色（カラーピッカー）で変更
変更した色を localStorage 保存
過去分に一括反映（最新以外）

---------------------------------------------------------------

9) 配信モード

「配信モード」ボタンで UIパネルを非表示（画面がスッキリ）
ESCで戻す（配信中の復帰が簡単）


10) 複数タブ/OBS等との同期

localStorage の変更（travelHistory）を storage イベントで検知し、

履歴を読み直し
マーカー/線を全消し
もう一度復元
という同期が可能（別タブ・別プロセス表示の整合性）
